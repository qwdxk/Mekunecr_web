name: 处理登录申请

on:
  workflow_dispatch:
    inputs:
      username:
        description: '用户名'
        required: true
      client_id:
        description: '申请ID'
        required: true

jobs:
  process-login:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: 初始化状态文件
      run: |
        # 确保状态文件存在
        if [ ! -f "login_status.json" ]; then
          echo "{}" > login_status.json
        fi
        
        # 添加新的申请
        python3 -c "
import json
import os
from datetime import datetime

username = os.environ['USERNAME']
client_id = os.environ['CLIENT_ID']

# 读取状态文件
with open('login_status.json', 'r') as f:
    status_data = json.load(f)

# 添加新申请
status_data[client_id] = {
    'username': username,
    'status': 'pending',
    'received_at': datetime.now().isoformat()
}

# 保存状态文件
with open('login_status.json', 'w') as f:
    json.dump(status_data, f, indent=2)

print(f'申请已添加: {username} ({client_id})')
        "

    - name: 提交更改
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add login_status.json
        git commit -m "添加登录申请: ${{ github.event.inputs.username }}"
        git push
