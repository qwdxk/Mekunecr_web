name: 处理登录申请

on:
  workflow_dispatch:
    inputs:
      username:
        description: '用户名'
        required: true
      client_id:
        description: '申请ID'
        required: true

# 添加工作流权限
permissions:
  contents: write

jobs:
  process-login:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        # 使用具有写入权限的token
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: 设置Git配置
      run: |
        git config --global user.email "github-actions@github.com"
        git config --global user.name "github-actions"

    - name: 处理申请
      run: |
        echo "处理登录申请..."
        echo "用户名: ${{ github.event.inputs.username }}"
        echo "申请ID: ${{ github.event.inputs.client_id }}"
        
        # 确保状态文件存在
        if [ ! -f "login_status.json" ]; then
          echo "{}" > login_status.json
        fi
        
        # 使用Python处理申请
        python3 << 'EOF'
import json
import os
from datetime import datetime

username = os.environ['USERNAME']
client_id = os.environ['CLIENT_ID']

# 读取状态文件
try:
    with open('login_status.json', 'r', encoding='utf-8') as f:
        status_data = json.load(f)
except:
    status_data = {}

# 添加新申请
status_data[client_id] = {
    "username": username,
    "status": "pending",
    "received_at": datetime.now().isoformat()
}

# 保存状态文件
with open('login_status.json', 'w', encoding='utf-8') as f:
    json.dump(status_data, f, indent=2, ensure_ascii=False)

print("申请已添加到状态文件")
EOF

    - name: 提交更改
      run: |
        git add login_status.json
        
        # 检查是否有更改
        if git diff --staged --quiet; then
          echo "没有更改需要提交"
        else
          git commit -m "添加登录申请: ${{ github.event.inputs.username }}"
          git push origin main
          echo "更改已提交"
        fi
